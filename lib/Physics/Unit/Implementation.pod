=head1 NAME

Physics::Unit::Implementation - This page discusses implementation issues of the Physics/Unit.pm
module.

=head1 Overview

Objects of class Unit define units of measurement that correspond to
physical quantities. This module allows you to manipulate these
units, generate new derived units from other units, and convert from
one unit to another. Each unit is defined by a conversion factor and
a dimensionality vector.

The conversion factor is a floating point number that specifies how
this unit relates to a reference unit of the same dimensionality.

The dimensionality vector holds a list of integers - each of which
records the power of a base unit in this unit.

For example, consider the unit of speed, "miles per hour". This has a
dimensionality of (Distance / Time), or of (Distance ^ 1 * Time ^ -1).
So this unit's dimensionality vector has a 1 in the place
corresponding to Distance, and a -1 in the place corresponding to
Time.

The reference unit for speed is "meters per second" (since meter is
the base unit corresponding to Distance, and second is the base unit
corresponding to Time). Therefore, the conversion factor for the unit
"miles per hour" is 0.44704, since 1 mph equals 0.44704 meters / sec.

Try this:

  print "One mph is ", GetUnit('mph')->factor, " meters / sec\n";

=head1 Package Variables

=head2 $debug

Turning this on enables copious debugging information. This is a
package global, not a file-scoped lexical. So it can be turned on
like this

  BEGIN { $Physics::Unit::debug = 1; }

  use Physics::Unit;

=head2 $number_re

This is the regular expression used to parse out a number.  It is
here so that other modules can use it for convenience.

A (correct) regular expression for a floating point number,
optionally in exponent form. This is hard to come by.

This variable may also be imported for ease of use.



=head1 Data Structures

=head2 %reserved_word

A list of reserved words used in unit expressions.  For example, "per",
"square", "cubic".

=head2 %unit_by_name

A list of all known unit names. The value of the hash is a reference
to the named unit object.

=head2 %prefix

A list of all the valid prefixes. The value of the hash is a
reference to the unit object. Note that the names here are also in
%unit_by_name.

These are special case unit names that can be attached to other units
with no intervening spaces.

=head2 %prototype

A list of all the known types. The values of this hash are references
to unit objects that exemplify these types. I.e., any other units
that have the same type will have the same dimensionality as the
example unit.

=head2 $NumBases

The number of base units.

=head2 @BaseName

The name of each of the base units. These names also appear in
%unit_by_name.


=head1 Initialization

InitBaseUnit is called to inform the library how many independent
dimensional quantities there are, and what the 'base' unit is for
each quantity.
The library is initialized to know about nine quantities.  More can
be added at run-time, if desired.

InitPrefix is called to initialize the prefixes.
Prefixes are just like dimensionless units, but they don't need to
be separated from the next unit by a space.
Prefix units can only have one name.

Next, InitUnit is called to define units in terms of other units.
Note:  no forward references are allowed here.





=head1 Private Implementation Routines

These are not part of the user-interface.  These are only for use
within the package.

=head2 NewOne()

Creates a new dimensionless unit.

=head2 AddNames()

This is called during the object's construction to add a list of
names to the 'names' array, and to set the reference in the
%unit_by_names cross-reference hash.

=head2 NewType()

   $u->NewType('type');

This is called when we are adding a new type to the system.  This
happens both in InitBaseUnits() and in InitTypes().

=head2 CreateUnit()

This is used by several of the interface utility functions to create
a new unit object from a unit definition (either a simple name, a
unit expression, or a unit object).

It differs from GetUnit in that it always creates a new, anonymous
unit, whereas GetUnit, if given a simple name, returns a reference
to a named unit.

=head2 CompareDim()

Compare the dimension arrays.
Return 0 if they are the same.

=head2 LookName()

Look up the name.  Returns:

  0 not defined
  1 reserved word
  2 unit name
  3 type name

=head2 DebugString()

Convert the unit to a factor - dimension vector format string, e.g.
the unit '3 meters' would be converted to something like

  3 [1, 0, 0]

=head2 CheckChange()

Complain if this unit has a name.  This is used by all the methods
that modify the value of the unit.

=head1 The Parser / Unit Expression Grammar

Below are listed the private parser functions.
See also the grammar description in the Unit.pm documentation.

=head2 expr()

  expr : term
       | term '/' expr
       | term '*' expr
       | term 'per' expr

=head2 term()

  term : factor
       | term factor

A term is any number of factors separated (nominally) by whitespace.
Whitespace is an 'operator' that means the same thing as multiplication,
but has a higher priority than either '*', '/', or 'per'.

Examples of terms (the following lines each contain one term):

  3pi radians
  3e+4 globules

=head2 Factor()

  factor : prim
         | prim '**' integer

Note that a primary can be an integer, of course, so factors can
look like this:

  meter ** 3 ^ 5    # note, '**' and '^' are synonymous

=head2 prim()

  prim : number
       | word
       | '(' expr ')'
       | 'square' primary
       | 'sq' primary
       | 'cubic' primary
       | primary 'squared'
       | primary 'cubed'

The unary operators square, sq, cubic, squared, and cubed are
implemented as part of this function.  Thus they have quite a
high precedence, as I think they should.


=head2 get_token()

Only used by new above to parse the unit definition string.

